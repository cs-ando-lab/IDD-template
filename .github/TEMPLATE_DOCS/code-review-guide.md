# 🎯 コードレビューガイドライン

このガイドは、建設的で学びのあるコードレビューを実現するための指針です。

---

## 📖 目次
1. [コードレビューの目的](#コードレビューの目的)
2. [レビュアー（見る人）の心得](#レビュアー見る人の心得)
3. [レビュイー（書いた人）の心得](#レビュイー書いた人の心得)
4. [レビューの進め方](#レビューの進め方)
5. [コメントの書き方](#コメントの書き方)
6. [チェックリスト](#チェックリスト)

---

## 🎯 コードレビューの目的

### 主な目的
1. **品質向上**: バグやセキュリティ問題の早期発見
2. **知識共有**: コードベースやベストプラクティスの共有
3. **一貫性**: コーディングスタイルやアーキテクチャの統一
4. **学習機会**: お互いに学び合う場
5. **責任の分散**: チーム全体でコード品質に責任を持つ

### ❌ レビューの目的ではないこと
- ❌ マウントを取る場
- ❌ 相手を批判する場
- ❌ 完璧を求める場
- ❌ 自分の好みを押し付ける場

---

## 👀 レビュアー（見る人）の心得

### ✅ 基本姿勢

#### 1. 建設的であること
```
❌ 「このコードはダメです」
✅ 「この実装だとXXの場合に問題が出る可能性があります。YYのように変更してはどうでしょうか？」
```

#### 2. 具体的であること
```
❌ 「パフォーマンスが悪い」
✅ 「このループはO(n²)になっています。Mapを使えばO(n)に改善できます：[コード例]」
```

#### 3. 敬意を持つこと
```
❌ 「なんでこんな書き方するんですか？」
✅ 「この実装を選んだ理由を教えていただけますか？」
```

#### 4. 前向きであること
```
❌ 「全部やり直してください」
✅ 「XXの部分は素晴らしいです！YYについて、こういうアプローチも検討できそうです」
```

### 📋 レビューの手順

#### Step 1: コンテキストを理解する（5分）
1. **Issue を読む**: 何を実現したいのか
2. **PR説明を読む**: どう実装したのか
3. **完了条件（DoD）を確認**: 何が満たされるべきか

#### Step 2: 全体像を把握する（10分）
1. **変更ファイル一覧を確認**: 影響範囲を理解
2. **大きな設計を見る**: アーキテクチャは適切か
3. **テストを確認**: 十分なカバレッジか

#### Step 3: 詳細をレビューする（20-40分）
1. **ロジック**: 正しく動作するか
2. **エッジケース**: 異常系の考慮
3. **セキュリティ**: 脆弱性はないか
4. **パフォーマンス**: ボトルネックはないか
5. **可読性**: 理解しやすいか
6. **保守性**: 将来変更しやすいか

#### Step 4: フィードバックを伝える（10分）
1. **良い点を伝える**: ポジティブなフィードバック
2. **改善点を提案**: 具体的で実行可能な提案
3. **優先度を示す**: 必須 / 提案 / nit

### 🎨 コメントの種類

#### 🔴 Blocking（必須修正）
セキュリティ、バグ、重大な設計問題など、マージ前に必ず修正すべき事項

```
🔴 **Blocking**: XSS脆弱性

ユーザー入力がエスケープされていません。
DOMPurifyでサニタイズしてください。
```

#### 🟡 Suggestion（提案）
改善したほうが良いが、必須ではない事項

```
💡 **Suggestion**: パフォーマンス改善

O(n²)のループがありますが、Mapを使えばO(n)に改善できます。
ただし、データ量が少ない場合は現状でも問題ないと思います。
```

#### ⚪ Nit（些細な指摘）
スタイルや好みの問題

```
**nit**: 変数名について

`data` より `userData` の方が意図が明確かもしれません。
ただ、これは好みの問題なので、お任せします 😊
```

#### 💬 Question（質問）
純粋な質問や確認

```
❓ **Question**:

この timeout 値は何を基準に決めましたか？
ユーザー体験の観点から適切か確認したいです。
```

#### 👏 Praise（称賛）
良い実装への評価

```
👏 **素晴らしい！**

エラーハンドリングが丁寧に実装されていて、
ユーザーへのフィードバックも適切ですね！
```

### ⏱️ レビューのタイミング

- **24時間以内**: できるだけ早くレビュー開始
- **小まめに**: 大きなPRは段階的にレビュー
- **集中できる時間**: 中断されない時間帯を選ぶ
- **複数回に分けても OK**: 一度にすべて完璧にレビューしなくてもよい

---

## 📝 レビュイー（書いた人）の心得

### ✅ PR作成前

#### 1. セルフレビューを必ず行う
自分のコードを一度見直す。誰かに見てもらう前に、自分で気づける問題は修正。

**チェック項目:**
- [ ] 意図した変更のみが含まれている
- [ ] デバッグコードやコメントアウトが残っていない
- [ ] テストが追加されている
- [ ] タイポがない
- [ ] コミットメッセージが適切

#### 2. レビューしやすいサイズに
- **目安**: 300行以内
- **大きすぎる場合**: 複数のPRに分割
- **分割できない場合**: PR説明で構造を説明

#### 3. 丁寧な説明を書く
- なぜこの変更が必要か
- どのように実装したか
- 特に見てほしいポイント
- スクリーンショット（UI変更の場合）

### ✅ レビュー中

#### 1. フィードバックを前向きに受け取る
```
❌ 「そんなこと言われても...」
✅ 「なるほど！その視点は考えていませんでした。修正します」
```

#### 2. 質問には丁寧に答える
レビュアーの質問は、コードが分かりにくい可能性のサイン。
説明だけでなく、コードを改善するチャンスと捉える。

#### 3. 議論を恐れない
意見が分かれた場合は、建設的に議論する。
必要に応じて、他のメンバーの意見も求める。

#### 4. 感謝を伝える
```
✅ 「レビューありがとうございます！修正しました」
✅ 「その指摘は気づきませんでした。勉強になります！」
```

### ✅ レビュー後

#### 1. 指摘事項を確実に対応
- Blockingは必ず修正
- Suggestionも可能な限り対応
- 対応しない場合は理由を説明

#### 2. 対応状況を明確に
```markdown
✅ 修正しました: [コミットへのリンク]
✅ XXXを YYY に変更しました
💬 これについてはZZZの理由で現状のままとさせてください
```

#### 3. 再レビューを依頼
```
@reviewer 指摘いただいた点を修正しました。再度確認をお願いします 🙏
```

---

## 🔄 レビューの進め方

### パターン1: 小規模PR（100行以下）

```
1. レビュアーがレビュー（30分以内）
2. レビュイーが修正（1時間以内）
3. レビュアーが承認
4. マージ
```

### パターン2: 中規模PR（100-300行）

```
1. レビュアーが初回レビュー（1時間）
2. レビュイーが修正（2-4時間）
3. レビュアーが再レビュー（30分）
4. 必要に応じて議論
5. 承認・マージ
```

### パターン3: 大規模PR（300行以上）

```
1. 事前に設計レビュー（アプローチの確認）
2. 段階的な実装とレビュー
3. 最終的な統合レビュー
4. 承認・マージ
```

### 複数レビュアーの場合

- **最低1名の承認**: 必須
- **全員の承認**: 重要な変更の場合
- **専門家の承認**: セキュリティなど特定領域

---

## 💬 コメントの書き方

### テンプレート

```markdown
[優先度: 🔴Blocking / 💡Suggestion / ⚪Nit / ❓Question / 👏Praise]

**現状の問題点:**
...

**提案:**
```コード例```

**理由:**
...

**参考:**
[リンク]
```

### 実例集

詳細は [良いレビュー例](examples/good-code-review.md) を参照。

---

## ✅ レビューチェックリスト

### 機能面
- [ ] Issueの要件を満たしている
- [ ] 完了条件（DoD）が達成されている
- [ ] エッジケースが考慮されている
- [ ] エラーハンドリングが適切

### コード品質
- [ ] ロジックが正しい
- [ ] 可読性が高い
- [ ] 適切に抽象化されている
- [ ] 重複コードがない
- [ ] 命名が適切

### セキュリティ
- [ ] 入力バリデーションがある
- [ ] 認証・認可が適切
- [ ] 機密情報が含まれていない
- [ ] XSS、SQLインジェクション等の脆弱性がない

### パフォーマンス
- [ ] 明らかなボトルネックがない
- [ ] メモリリークの可能性がない
- [ ] 不要な再レンダリングがない

### テスト
- [ ] テストが追加されている
- [ ] テストカバレッジが十分
- [ ] テストが適切に書かれている

### ドキュメント
- [ ] コメントが適切
- [ ] README等の更新が必要なら対応されている
- [ ] APIドキュメントが更新されている

---

## 🎓 よくある質問

### Q1: どこまで細かく指摘すべき？

**A:** 優先度を明示することが重要です。

- **Blocking**: セキュリティ、バグ、重大な設計問題
- **Suggestion**: 改善提案（対応は任意）
- **Nit**: スタイルの好み（対応不要でもOK）

### Q2: 意見が対立したらどうする？

**A:** 建設的な議論を心がけましょう。

1. それぞれの意見の根拠を説明
2. トレードオフを明確にする
3. 第三者の意見を求める
4. チームの規約やベストプラクティスに従う
5. 時間をかけすぎない（決められないなら暫定的に進める）

### Q3: レビューに時間がかかりすぎる

**A:** 以下を試してください。

- PRを小さくする（300行以内）
- 重要な部分を「レビューポイント」として明示
- 段階的にレビュー（全部終わってから一度にコメントしない）
- ペアプロや同期的なレビューを検討

### Q4: レビューコメントが攻撃的に見える

**A:** 文章だけでは感情が伝わりにくいです。

- 絵文字を使う 😊
- 質問形式にする「〜してはどうでしょうか？」
- 理由を説明する
- 良い点も必ず伝える
- 必要に応じて通話で話す

---

## 📚 参考資料

- [Google Engineering Practices: Code Review](https://google.github.io/eng-practices/review/)
- [Conventional Comments](https://conventionalcomments.org/)
- [良いレビュー例](examples/good-code-review.md)

---

**Remember:** レビューは学び合いの場です。お互いをリスペクトし、コードとチームの成長を目指しましょう 🚀
